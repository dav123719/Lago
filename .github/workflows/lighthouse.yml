name: Lighthouse CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  lighthouse:
    name: Lighthouse CI - Performance Audit
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # CHECKOUT & SETUP
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ============================================
      # INSTALL DEPENDENCIES
      # ============================================
      - name: Install dependencies
        run: npm ci

      # ============================================
      # INSTALL LIGHTHOUSE CI
      # ============================================
      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      # ============================================
      # BUILD APPLICATION
      # ============================================
      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SITE_URL: https://lago.lv
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
          ANALYZE: false

      # ============================================
      # RUN LIGHTHOUSE CI
      # ============================================
      - name: Run Lighthouse CI
        run: lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      # ============================================
      # UPLOAD REPORTS (ALWAYS)
      # ============================================
      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: |
            .lighthouseci/
            lighthouse-report.html
          retention-days: 30

      # ============================================
      # COMMENT ON PR (if applicable)
      # ============================================
      - name: Comment Lighthouse results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find the latest LHCI results
            const lhciDir = '.lighthouseci';
            if (!fs.existsSync(lhciDir)) {
              console.log('No LHCI results found');
              return;
            }
            
            const files = fs.readdirSync(lhciDir);
            const jsonFiles = files.filter(f => f.endsWith('.json') && f.startsWith('lhr-'));
            
            if (jsonFiles.length === 0) {
              console.log('No LHR files found');
              return;
            }
            
            // Get the most recent file
            const latestFile = jsonFiles.sort().pop();
            const lhr = JSON.parse(fs.readFileSync(path.join(lhciDir, latestFile), 'utf8'));
            
            const { categories, audits } = lhr;
            
            // Helper to format score
            const formatScore = (score) => {
              const percentage = Math.round(score * 100);
              const emoji = percentage >= 90 ? 'ðŸŸ¢' : percentage >= 75 ? 'ðŸŸ¡' : 'ðŸ”´';
              return `${emoji} ${percentage}`;
            };
            
            // Helper to format value
            const formatValue = (value, unit = '') => {
              return value !== undefined ? `${value}${unit}` : 'N/A';
            };
            
            // Build comment body
            const comment = `## âš¡ Lighthouse CI Results
            
            | Category | Score |
            |----------|-------|
            | Performance | ${formatScore(categories.performance?.score)} |
            | Accessibility | ${formatScore(categories.accessibility?.score)} |
            | Best Practices | ${formatScore(categories['best-practices']?.score)} |
            | SEO | ${formatScore(categories.seo?.score)} |
            | PWA | ${formatScore(categories.pwa?.score)} |
            
            ### Core Web Vitals
            
            | Metric | Value | Target |
            |--------|-------|--------|
            | First Contentful Paint | ${formatValue(Math.round(audits['first-contentful-paint']?.numericValue), 'ms')} | < 2000ms |
            | Largest Contentful Paint | ${formatValue(Math.round(audits['largest-contentful-paint']?.numericValue), 'ms')} | < 2500ms |
            | Total Blocking Time | ${formatValue(Math.round(audits['total-blocking-time']?.numericValue), 'ms')} | < 200ms |
            | Cumulative Layout Shift | ${formatValue(audits['cumulative-layout-shift']?.numericValue?.toFixed(3))} | < 0.1 |
            | Speed Index | ${formatValue(Math.round(audits['speed-index']?.numericValue), 'ms')} | < 3000ms |
            
            [View detailed report](${lhr.finalUrl})
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const lighthouseComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('Lighthouse CI Results')
            );
            
            if (lighthouseComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: lighthouseComment.id,
                body: comment,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

      # ============================================
      # CHECK PERFORMANCE BUDGET
      # ============================================
      - name: Check performance budget
        run: |
          echo "Checking performance budget compliance..."
          
          # Find the latest LHCI JSON file
          LATEST_LHR=$(ls -t .lighthouseci/lhr-*.json | head -n1)
          
          if [ -f "$LATEST_LHR" ]; then
            # Extract scores using jq if available, or node
            if command -v jq &> /dev/null; then
              PERF_SCORE=$(jq '.categories.performance.score' "$LATEST_LHR")
              LCP=$(jq '.audits["largest-contentful-paint"].numericValue' "$LATEST_LHR")
              CLS=$(jq '.audits["cumulative-layout-shift"].numericValue' "$LATEST_LHR")
              TBT=$(jq '.audits["total-blocking-time"].numericValue' "$LATEST_LHR")
            else
              # Fallback to Node.js
              PERF_SCORE=$(node -e "console.log(require('$LATEST_LHR').categories.performance.score)")
              LCP=$(node -e "console.log(require('$LATEST_LHR').audits['largest-contentful-paint'].numericValue)")
              CLS=$(node -e "console.log(require('$LATEST_LHR').audits['cumulative-layout-shift'].numericValue)")
              TBT=$(node -e "console.log(require('$LATEST_LHR').audits['total-blocking-time'].numericValue)")
            fi
            
            echo "Performance Score: $PERF_SCORE"
            echo "LCP: ${LCP}ms"
            echo "CLS: $CLS"
            echo "TBT: ${TBT}ms"
            
            # Fail if performance is below threshold (0.75 = 75)
            PERF_THRESHOLD=0.75
            if (( $(echo "$PERF_SCORE < $PERF_THRESHOLD" | bc -l) )); then
              echo "âŒ Performance score $PERF_SCORE is below threshold $PERF_THRESHOLD"
              exit 1
            fi
            
            echo "âœ… All performance budgets passed"
          else
            echo "Warning: No LHCI results found"
          fi
        continue-on-error: false
